<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shopify UTM Orders Dashboard — cleaner UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7fafc;
      --muted:#6b7280;
      --card:#ffffff;
      --primary:#111827;
      --accent:#2563eb;
      --warn-bg:#fffbeb;
      --warn-text:#b45309;
    }
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding:20px; background:var(--bg); color:#0f1724;}
    .wrap{max-width:1200px;margin:18px auto;}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(15,23,42,0.06);}
    h1{margin:0;font-size:20px;}
    .muted{color:var(--muted);font-size:13px;margin-top:6px;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px;}
    input[type=date], select{padding:8px;border-radius:8px;border:1px solid #e6edf3;background:white;}
    button{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:white;cursor:pointer;}
    button.ghost{background:transparent;color:var(--primary);border:1px solid #e6edf3;}
    button[disabled]{opacity:.45;cursor:not-allowed;}
    .small{font-size:12px;color:var(--muted);}
    .cols{display:flex;gap:6px;flex-wrap:wrap;margin-left:8px;}
    .col-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;border:1px solid #eef2f7;}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:14px;}
    .panel{padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef2f7;}
    .bulk{padding:10px;border-radius:8px;border:1px dashed #e6edf3;background:#fff;}
    .warn{color:var(--warn-text);background:var(--warn-bg);padding:8px;border-radius:8px;border:1px solid #f3e2c8;}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;}
    th{background:#fbfdff;position:sticky;top:0;}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .export-menu{display:flex;flex-direction:column;gap:6px;margin-left:8px;}
    .bottom-bar{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:12px;flex-wrap:wrap;}
    .stat{font-weight:600;}
    .tiny{font-size:11px;color:var(--muted);}
  </style>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Shopify UTM Orders Dashboard</h1>
      <div class="muted">Cleaned action layout — exports & bulk controls grouped for clarity.</div>

      <div id="root"></div>
    </div>
  </div>

  <script>
    const e = React.createElement;
    const { useState } = React;

    function humanDateRangeDays(start, end){
      if(!start || !end) return 0;
      const s = new Date(start + 'T00:00:00Z');
      const eD = new Date(end + 'T23:59:59Z');
      const diff = Math.max(0, Math.round((eD - s) / (1000*60*60*24))) + 1;
      return diff;
    }

    function App(){
      const [start,setStart] = useState('');
      const [end,setEnd] = useState('');
      const [orders,setOrders] = useState([]);
      const [shopifyTotal,setShopifyTotal] = useState(null);
      const [totalFetched,setTotalFetched] = useState(0);
      const [page,setPage] = useState(1);
      const [pageSize,setPageSize] = useState(50);
      const [loading,setLoading] = useState(false);
      const [status,setStatus] = useState('');
      const [cols,setCols] = useState({
        order_number:true, created_at:true,
        utm_source:true, utm_medium:true, utm_campaign:true, utm_term:true, utm_content:true
      });

      // Bulk
      const [bulkStatus,setBulkStatus] = useState(null);
      const [bulkObjects,setBulkObjects] = useState(null);
      const [busyBulk,setBusyBulk] = useState(false);

      const colKeys = Object.keys(cols);

      async function fetchPage(p=1){
        if(!start || !end){ alert('Please select a start and end date'); return; }
        setLoading(true); setStatus('Fetching orders...');
        try{
          const resp = await axios.get('/api/orders', { params: { start, end, page: p, pageSize } });
          const d = resp.data || {};
          setOrders(d.orders || []);
          setTotalFetched(d.total_fetched || 0);
          setShopifyTotal(d.shopify_total === null ? 'unknown' : d.shopify_total);
          setPage(d.page || p);
          setStatus('Fetched '+ (d.orders||[]).length + ' rows.'); 
        }catch(err){
          console.error(err);
          setStatus('Error: ' + (err.response && err.response.data && err.response.data.error ? err.response.data.error : err.message));
          setOrders([]);
          setTotalFetched(0);
          setShopifyTotal(null);
        }finally{
          setLoading(false);
        }
      }

      function toggleCol(k){ setCols({...cols, [k]: !cols[k]}); }

      // Export (REST)
      function exportRest(preview=0){
        if(!start || !end){ alert('Please select a start and end date'); return; }
        const colsParam = colKeys.filter(k=>cols[k]).join(',');
        const params = new URLSearchParams({ start, end, columns: colsParam });
        if (preview) params.set('preview', String(preview));
        window.location = '/api/export.csv?' + params.toString();
      }

      // Bulk handlers (Start / Status / Download)
      async function startBulk(){
        if(!start || !end){ alert('Please select a start and end date'); return; }
        setBusyBulk(true); setStatus('Starting bulk...');
        try{
          const resp = await axios.post('/api/bulk/start', { start, end });
          setBulkStatus(resp.data.status || 'STARTED');
          setStatus('Bulk started.');
        }catch(err){
          console.error(err);
          setStatus('Bulk start error: ' + (err.response && err.response.data && err.response.data.error ? err.response.data.error : err.message));
        }finally{ setBusyBulk(false); }
      }
      async function checkBulk(){
        setStatus('Checking bulk status...');
        try{
          const resp = await axios.get('/api/bulk/status');
          const d = resp.data || {};
          setBulkStatus(d.status || 'NONE');
          setBulkObjects(d.objectCount || null);
          setStatus('Bulk status: ' + (d.status || 'NONE'));
        }catch(err){
          console.error(err);
          setStatus('Bulk status error: ' + (err.response && err.response.data && err.response.data.error ? err.response.data.error : err.message));
        }
      }
      function downloadBulk(preview=0){
        const params = new URLSearchParams();
        if(preview) params.set('preview', String(preview));
        window.location = '/api/bulk/download?' + params.toString();
      }

      // Pagination helpers
      function prevPage(){ if(page > 1) fetchPage(page-1); }
      function nextPage(){ if(orders.length === 0 || orders.length < pageSize) return; fetchPage(page+1); }

      const showLargeHint = humanDateRangeDays(start, end) > 7;
      const noMorePages = orders.length < pageSize;

      return e('div', null,
        e('div', {className:'controls'},
          e('label', null, 'Start: ', e('input',{type:'date', value:start, onChange:ev=>setStart(ev.target.value)})),
          e('label', null, 'End: ', e('input',{type:'date', value:end, onChange:ev=>setEnd(ev.target.value)})),
          e('label', null, 'Page Size: ', e('select',{value:pageSize, onChange:ev=>setPageSize(Number(ev.target.value))},
            [25,50,100,200].map(n=> e('option',{key:n, value:n}, String(n)))
          )),
          e('div', {className:'toolbar'},
            e('button',{onClick:()=>fetchPage(1), disabled:loading}, loading ? 'Fetching...' : 'Fetch'),
            e('button',{onClick:()=>prevPage(), disabled:loading || page<=1, className:'ghost'}, 'Prev'),
            e('button',{onClick:()=>nextPage(), disabled:loading || noMorePages, className:'ghost'}, 'Next')
          ),
          e('div', {style:{marginLeft:'auto', display:'flex', gap:8, alignItems:'center'}},
            // Export group
            e('div', {className:'panel'},
              e('div', {className:'small', style:{marginBottom:6}}, 'Export'),
              e('div', {style:{display:'flex', gap:8}},
                e('button',{onClick:()=>exportRest(0), disabled:loading}, 'Export (REST)'),
                e('button',{onClick:()=>exportRest(50), disabled:loading, className:'ghost'}, 'Preview 50')
              )
            )
          )
        ),

        e('div', {className:'grid'},
          // Left: table + columns
          e('div', null,
            showLargeHint ? e('div', {style:{marginTop:10}}, e('div',{className:'warn'}, 'Large ranges (>7 days) — use Bulk export for reliable full exports.')) : null,

            // Stats
            e('div', {style:{display:'flex', gap:12, alignItems:'center', marginTop:12, flexWrap:'wrap'}},
              e('div', {className:'stat'}, 'Shopify total: ' + (shopifyTotal === null ? 'unknown' : shopifyTotal)),
              e('div', {className:'small'}, 'Rows fetched: ' + totalFetched),
              e('div', {className:'small'}, 'Page: ' + page)
            ),

            // Columns selector
            e('div', {style:{marginTop:12, display:'flex', gap:10, alignItems:'center', flexWrap:'wrap'}},
              e('div', {className:'small'}, 'Columns:'),
              e('div', {className:'cols'}, colKeys.map(k=> e('label',{key:k, className:'col-item'},
                e('input',{type:'checkbox', checked:cols[k], onChange:()=>toggleCol(k)}), k
              )))
            ),

            // Table
            e('div', {style:{marginTop:12}},
              orders.length === 0 ? e('div', {className:'small'}, 'No data — click Fetch') :
              e('table', null,
                e('thead', null, e('tr', null, colKeys.filter(c=>cols[c]).map(c=> e('th',{key:c}, c)))),
                e('tbody', null, orders.map((r,idx) => e('tr',{key:idx}, colKeys.filter(c=>cols[c]).map(c=> e('td',{key:c}, r[c] || '')))))
              )
            ),

            // bottom bar
            e('div', {className:'bottom-bar'},
              e('div', null,
                e('button',{onClick:prevPage, disabled:page<=1 || loading}, 'Prev'),
                e('button',{onClick:nextPage, disabled:loading || noMorePages, style:{marginLeft:8}}, 'Next')
              ),
              e('div', null,
                e('button',{onClick:()=>exportRest(0), disabled:loading}, 'Export (REST)'),
                e('button',{onClick:()=>exportRest(50), disabled:loading, className:'ghost', style:{marginLeft:8}}, 'Preview 50')
              )
            )
          ),

          // Right: Bulk panel
          e('div', null,
            e('div', {className:'panel'},
              e('div', {className:'small', style:{marginBottom:8}}, 'Bulk Export (recommended for large ranges)'),
              e('div', {className:'bulk'},
                e('div', {style:{display:'flex', gap:8, marginBottom:8}},
                  e('button',{onClick:startBulk, disabled:busyBulk}, busyBulk ? 'Starting...' : 'Start bulk'),
                  e('button',{onClick:checkBulk}, 'Check status')
                ),
                e('div', {style:{display:'flex', gap:8}},
                  e('button',{onClick:()=>downloadBulk(50)}, 'Download (preview 50)'),
                  e('button',{onClick:()=>downloadBulk(0), className:'ghost'}, 'Download (full)')
                ),
                e('div', {className:'tiny', style:{marginTop:8}}, bulkStatus ? ('Status: ' + bulkStatus + (bulkObjects ? ' — objects: ' + bulkObjects : '')) : 'No active bulk operation')
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
